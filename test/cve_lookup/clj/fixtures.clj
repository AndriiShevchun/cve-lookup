(ns cve-lookup.clj.fixtures
  (:require [clojure.test :refer :all]
            [clojure.tools.logging :as log]
            [clojure.java.jdbc :as jdbc]
            [clojure.java.io :as io]
            [cve-lookup.resources.config :as c]
            )
  (:import [com.opentable.db.postgres.embedded EmbeddedPostgres]))

(defn with-embedded-postgres [f]
  (log/info "[with-embedded-postgres]")
  (let [embedded-postgres (-> (EmbeddedPostgres/builder)
                              (.setPort (get c/test-dbspec :port))
                              (.start))]
    (try
      (f)
      (finally
        (.close embedded-postgres)))))

(defn with-migration [f]
  (log/info "[with-migration]")
  (jdbc/with-db-connection [db c/test-dbspec]
                           (jdbc/execute! db (slurp (io/resource "db/migration/tables_inits.sql")))
                           (f)))