(ns cve-lookup.clj.fixtures
  (:require [clojure.test :refer :all]
            [clojure.tools.logging :as log]
            [clojure.java.jdbc :as jdbc]
            [clojure.java.io :as io]
            [mount.core :as mount]
            [cve-lookup.config :as c]
            [cve-lookup.rpc.app :as a]
            )
  (:import [com.opentable.db.postgres.embedded EmbeddedPostgres]))

(defn with-test-config [f]
  (reset! c/config-file "cve_lookup/resources/test-config.edn")
  (mount/start #'c/root)
  (try
    (f)
    (finally
      (mount/stop #'c/root))))

(defn with-embedded-postgres [f]
  (log/info "[with-embedded-postgres]")
  (let [embedded-postgres (-> (EmbeddedPostgres/builder)
                              (.setPort (get (c/database) :port))
                              (.start))]
    (try
      (f)
      (finally
        (.close embedded-postgres)))))

(defn with-migration [f]
  (log/info "[with-migration]")
  (jdbc/with-db-connection [db (c/database)]
                           (jdbc/execute! db (slurp (io/resource "db/migration/tables_init.sql")))
                           (jdbc/execute! db (slurp (io/resource "db/migration/functions.sql")))
                           (f)))

(defn with-server [f]
  (log/info "[with-rpc-server]")
  (mount/start #'cve-lookup.rpc.app/server)
  (try
    (f)
    (finally
      (mount/stop #'cve-lookup.rpc.app/server))))