(ns cve-lookup.rpc.app-test
  (:require [clojure.test :refer :all]
            [cve-lookup.save :as s]
            [cve-lookup.clj.fixtures :as f]
            [clojure.java.jdbc :as jdbc]
            [clj-http.client :as client]
            [cheshire.core :refer :all]
            [cve-lookup.config :as c]
            [ring.middleware.json :refer :all]
            [cve-lookup.rpc.test-data :as data]))

(use-fixtures :once
              (join-fixtures [f/with-test-config
                              f/with-embedded-postgres
                              f/with-migration
                              f/with-server]))

(deftest get-cve-id-test
  (testing "Test get infor by"
    (jdbc/with-db-connection [db (c/database)]
                             (s/read-and-save-file ["test/cve_lookup/resources/test.json" "test.json"])
                             (is (= '({:severity "MEDIUM"})
                                    (jdbc/query db
                                                "select severity from cve_look_up where id = 'CVE-2006-7777'")))
                             (is (= data/app
                                    (parse-string (get
                                                    (client/get "http://localhost:4000/cve/CVE-2006-7777")
                                                    :body)))))))