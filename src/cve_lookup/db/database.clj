(ns cve-lookup.db.database
  (:require [cve-lookup.config :as config]
            [ragtime.jdbc :as jdbc]
            [ragtime.core :as core]
            [clojure.tools.logging :as log]))

(defn migrations-reporter [_ op id]
  (case op
    :up (log/info "Applying: " id)
    :down (log/info "Rolling back: " id)))

(defn migrate []
  (let [common-migrations (jdbc/load-resources "db/migration/")
        common-datastore (jdbc/sql-database (config/database) {:migrations-table "migrations"})]
    (core/migrate-all common-datastore {} common-migrations {:reporter migrations-reporter})))