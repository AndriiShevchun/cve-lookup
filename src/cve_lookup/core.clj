(ns cve-lookup.core
  (:require [clj-time.core :as t]
            [mount.core :as mount]
            [cve-lookup.config :as config]
            [clojure.tools.logging :as log]
            [cve-lookup.db.database :as db]
            [cve-lookup.rpc.app :as app]
            [cve-lookup.fetch :as f]))

(defn cve-worker []
  (mount/start #'config/root #'app/server)
  (let [expected-time (atom (t/now))]
    (while true
      (when (= (t/now) @expected-time)
        (f/load-files-by-link)
        (reset! expected-time (t/plus @expected-time (t/minutes 100)))))))

(defn migrate-database []
  (mount/start #'config/root #'db/datasource)
  (db/migrate)
  (mount/stop #'db/datasource))