(ns cve-lookup.core
  (:require [clj-time.core :as t]
            [mount.core :as mount]
            [cve-lookup.config :as config]
            [cve-lookup.db.database :as db]
            [cve-lookup.rpc.app :as app]
            [cve-lookup.fetch :as f]))

(defn cve-worker []
  (mount/start #'config/root #'app/server)
  (db/migrate)
  (let [expected-time (atom (t/now))]
    (while true
      (when (= (t/now) @expected-time)
        (f/load-files-by-link (config/mask-all-years))
        (reset! expected-time (t/plus @expected-time (t/days (config/schedule-days))))))))

(defn migrate-database []
  (mount/start #'config/root)
  (db/migrate))