(ns cve-lookup.rpc.app
  (:require [compojure.api.sweet :refer [api routes GET]]
            [schema.core :as s]
            [cve-lookup.db.repository :as repo]
            [cve-lookup.db.database :as db]
            [ring.util.response :refer :all]
            [ring.middleware.defaults :refer :all]
            [ring.middleware.json :refer :all]
            [clj-postgresql.types :as tp]
            [mount.core :as mount :refer [defstate]]
            [cve-lookup.config :as c]
            [ring.adapter.jetty :refer [run-jetty]]))

(defn cve-id-handler [id]
  (response (repo/select-cve-id (c/database) {:id id})))

(def app-routes
  [(GET "/cve/:id" []
     :path-params [id :- s/Str]
     (cve-id-handler id))])

(def swagger-config
  {:ui      "/swagger"
   :spec    "/swagger.json"
   :options {:ui   {:validatorUrl nil}
             :data {:info {:version "1.0.0", :title "CVE_Lookup"}}}})

(def app (api {:swagger swagger-config} (apply routes app-routes)))


(defstate server
          :start (run-jetty app (c/server))
          :stop (.stop server))



