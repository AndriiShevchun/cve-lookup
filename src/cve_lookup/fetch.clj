(ns cve-lookup.fetch
  (:require [net.cgrand.enlive-html :as html]
            [clj-http.client :as httpc]
            [cve-lookup.save :as s]
            [cve-lookup.db.database :as db]
            [cve-lookup.utils :as u])
  (:import [java.net URL]
           [java.io File]))

(def nvd-nist-gov "https://nvd.nist.gov/vuln/data-feeds#JSON_FEED")
(def dir "/Users/andriishevchun/Test_projects/cve_lookup/resources/downloads")

(defn download-unzip [url dir]
  (let [stream (-> (httpc/get url {:as :stream})
                           (:body)
                           (java.util.zip.ZipInputStream.))
        savePath (str dir File/separatorChar (.getName (.getNextEntry stream)))
        saveFile (File. savePath)]
      (clojure.java.io/copy stream saveFile)
      (str saveFile)))

(defn load-files-by-link
  []
  (let [page (html/html-resource (URL. nvd-nist-gov))
        table (first (html/select page [:table]))
        links (u/find-nested (html/select table
                                        [(html/attr-contains :data-testid "-zip-20") :a])
                           :href)]
    (doseq [link links]
      (s/read-and-save-file
       (download-unzip link
                        dir)))))