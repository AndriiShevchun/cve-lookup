(ns cve-lookup.fetch
  (:require [net.cgrand.enlive-html :as html]
            [clj-http.client :as httpc]
            [clojure.tools.logging :as log]
            [cve-lookup.save :as s]
            [cve-lookup.config :as con]
            [cve-lookup.utils :as u])
  (:import [java.net URL]
           [java.io File]))

(defn download-unzip [url]
  (let [stream (-> (httpc/get url {:as :stream})
                   (:body)
                   (java.util.zip.ZipInputStream.))
        fileName (.getName (.getNextEntry stream))
        savePath (str (con/downloading-dir)
                      File/separatorChar
                      fileName)
        saveFile (File. savePath)]
    (clojure.java.io/copy stream saveFile)
    (future
      (s/read-and-save-file [(str saveFile)
                             fileName])
      (log/info "File"
                fileName
                "loaded to DB"))))

(defn load-files-by-link []
  (let [page (html/html-resource (URL. (con/site-nvd-nist-gov)))
        table (first (html/select page [:table]))
        links (u/find-nested (html/select table
                                          [(html/attr-contains :data-testid "-zip-20") :a])
                             :href)]
    (log/info "Found"
              (count links)
              "files from site")
    (log/info "Loading...")
    (doall (pmap download-unzip links))))